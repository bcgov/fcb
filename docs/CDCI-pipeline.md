# Overview

SMK and the SMK command line allow non technical users to easily author
web maps that can consume a variety of different spatial data sets 
including:

* WMS
* ArcGIS Server Rest
* Other misc custom data sources

DataBC wants to be able to publish SMK based apps easily and efficiently into
a single SMK openshift workspace.  The workspace (dev|test|prod|tools) in theory could host 
hundreds of smk apps.  The deployment process should be as automated as possible.

At a high level the CD/CI pipeline used for SMK apps will perform
the following steps:

1. Pull Request (PR) on Github triggers the Build
1. Successful completion of the build will trigger a *dev* deployment to ocp4
1. completion of the *dev* deployment will update the PR issue with a temporary url of the *dev* app.
1. accept/merge of the PR triggers the *prod* deployment.

# Details

The full CD/CI pipeline is initiated by github actions.  How the pipeline code
gets added to the repo is still yet to be determined.  Some idea include:

1. code is injected into the repository when the smk-cli tool is run
1. smk repo's inherit from a github templated repo that contains the actions code
1. users copy code into the repo, (likely the inital choice)

The last option is likely how things will initially be handled.  Possibly will
evolve to one of the other options as time allows.

The CD/CI pipeline will be built so that it will simply skip over steps that 
cannot be run due to the absence of secrets.  Once secrets are added to the
repo the next time the action runs it will process what it can based on 
what secrets are populated.

Ideally all smk based apps should use the same actions.  Ideally actions are 
linked and not embedded into repositories allowing DataBC to update actions 
without having to update each individual repository that has them embedded 
into them.

## Build

Build is initiated by a PR to Github's master branch.  The build creates a 
docker image and stores it as a github package.  The following is an example
of the package for the project: 
[smk-fap-fcp](https://github.com/orgs/bcgov/packages?repo_name=smk-fap-fcb)

Images are labelled using a timestamp.  [List of releases](https://github.com/bcgov/smk-fap-fcb/releases)

The build process calculates an image tag, then caches it in OCP as a configmap for 
subsequent deployments.  If the ocp credentials are not populated then the
tag will not get populated.

### Credentials used by Build / Deploy Github Actions

* GHCR_TOKEN: used to authenticate to github for different api calls
* GHCR_USER: used to authenticate to github, not actually required for the 
            current flow, but future proofing the code to allow for eventual
            migration from github packages to github container registry 
            (ghcr.io)
* OPENSHIFT_SERVER_URL: the url that is used to communicate with openshift (the url used to authenticate oc cli)
* OPENSHIFT_TOKEN_DEV: service account api key for the dev oc project.  This key
    is generated the first time the helm chart is run in ocp4.  This is the 
    api key for the dev namespace.  Used by steps that deploy to dev.
* OPENSHIFT_TOKEN_PROD: service account api key for the prod oc project.  This key
    is generated by the smk init help chart and is the api key for the prod 
    namespace.  Used by steps that deploy to prod.

## Deployment Pre-requisites

Actions have been configured so that they will not run until the secrets above
have been populated.  The actions will actually run, they just won't actually 
do anything. Once these parameters are populated, subsequent PR's should 
successfully trigger a deployment to Github.
